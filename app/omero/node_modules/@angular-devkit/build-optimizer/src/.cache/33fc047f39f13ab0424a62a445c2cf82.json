{"remainingRequest":"/Users/moises/source/code.research/sails-hook-redbox-omero/app/omero/node_modules/@angular-devkit/build-optimizer/src/build-optimizer/webpack-loader.js??ref--3-1!/Users/moises/source/code.research/sails-hook-redbox-omero/app/omero/node_modules/uppy/lib/plugins/ThumbnailGenerator/index.js","dependencies":[{"path":"/Users/moises/source/code.research/sails-hook-redbox-omero/app/omero/node_modules/uppy/lib/plugins/ThumbnailGenerator/index.js","mtime":1521677675000},{"path":"/Users/moises/source/code.research/sails-hook-redbox-omero/app/omero/node_modules/cache-loader/dist/cjs.js","mtime":1528352013145},{"path":"/Users/moises/source/code.research/sails-hook-redbox-omero/app/omero/node_modules/@angular-devkit/build-optimizer/src/build-optimizer/webpack-loader.js","mtime":1519266497000}],"contextDependencies":[],"result":["var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\n\nvar _Promise = typeof Promise === 'undefined' ? require('es6-promise').Promise : Promise;\n\nvar Plugin = require('../../core/Plugin');\nvar Utils = require('../../core/Utils');\n/**\n * The Thumbnail Generator plugin\n *\n */\n\nmodule.exports = function (_Plugin) {\n  _inherits(ThumbnailGenerator, _Plugin);\n\n  function ThumbnailGenerator(uppy, opts) {\n    _classCallCheck(this, ThumbnailGenerator);\n\n    var _this = _possibleConstructorReturn(this, _Plugin.call(this, uppy, opts));\n\n    _this.type = 'thumbnail';\n    _this.id = 'ThumbnailGenerator';\n    _this.title = 'Thumbnail Generator';\n    _this.queue = [];\n    _this.queueProcessing = false;\n\n    var defaultOptions = {\n      thumbnailWidth: 200\n    };\n\n    _this.opts = _extends({}, defaultOptions, opts);\n\n    _this.addToQueue = _this.addToQueue.bind(_this);\n    return _this;\n  }\n\n  /**\n   * Create a thumbnail for the given Uppy file object.\n   *\n   * @param {{data: Blob}} file\n   * @param {number} width\n   * @return {Promise}\n   */\n\n\n  ThumbnailGenerator.prototype.createThumbnail = function createThumbnail(file, targetWidth) {\n    var _this2 = this;\n\n    var originalUrl = URL.createObjectURL(file.data);\n    var onload = new _Promise(function (resolve, reject) {\n      var image = new Image();\n      image.src = originalUrl;\n      image.onload = function () {\n        URL.revokeObjectURL(originalUrl);\n        resolve(image);\n      };\n      image.onerror = function () {\n        // The onerror event is totally useless unfortunately, as far as I know\n        URL.revokeObjectURL(originalUrl);\n        reject(new Error('Could not create thumbnail'));\n      };\n    });\n\n    return onload.then(function (image) {\n      var targetHeight = _this2.getProportionalHeight(image, targetWidth);\n      var canvas = _this2.resizeImage(image, targetWidth, targetHeight);\n      return _this2.canvasToBlob(canvas, 'image/png');\n    }).then(function (blob) {\n      return URL.createObjectURL(blob);\n    });\n  };\n\n  /**\n   * Make sure the image doesnâ€™t exceed browser/device canvas limits.\n   * For ios with 256 RAM and ie\n   */\n\n\n  ThumbnailGenerator.prototype.protect = function protect(image) {\n    // https://stackoverflow.com/questions/6081483/maximum-size-of-a-canvas-element\n\n    var ratio = image.width / image.height;\n\n    var maxSquare = 5000000; // ios max canvas square\n    var maxSize = 4096; // ie max canvas dimensions\n\n    var maxW = Math.floor(Math.sqrt(maxSquare * ratio));\n    var maxH = Math.floor(maxSquare / Math.sqrt(maxSquare * ratio));\n    if (maxW > maxSize) {\n      maxW = maxSize;\n      maxH = Math.round(maxW / ratio);\n    }\n    if (maxH > maxSize) {\n      maxH = maxSize;\n      maxW = Math.round(ratio * maxH);\n    }\n    if (image.width > maxW) {\n      var canvas = document.createElement('canvas');\n      canvas.width = maxW;\n      canvas.height = maxH;\n      canvas.getContext('2d').drawImage(image, 0, 0, maxW, maxH);\n      image.src = 'about:blank';\n      image.width = 1;\n      image.height = 1;\n      image = canvas;\n    }\n\n    return image;\n  };\n\n  /**\n   * Resize an image to the target `width` and `height`.\n   *\n   * Returns a Canvas with the resized image on it.\n   */\n\n\n  ThumbnailGenerator.prototype.resizeImage = function resizeImage(image, targetWidth, targetHeight) {\n    // Resizing in steps refactored to use a solution from\n    // https://blog.uploadcare.com/image-resize-in-browsers-is-broken-e38eed08df01\n\n    image = this.protect(image);\n\n    var steps = Math.ceil(Math.log2(image.width / targetWidth));\n    if (steps < 1) {\n      steps = 1;\n    }\n    var sW = targetWidth * Math.pow(2, steps - 1);\n    var sH = targetHeight * Math.pow(2, steps - 1);\n    var x = 2;\n\n    while (steps--) {\n      var canvas = document.createElement('canvas');\n      canvas.width = sW;\n      canvas.height = sH;\n      canvas.getContext('2d').drawImage(image, 0, 0, sW, sH);\n      image = canvas;\n\n      sW = Math.round(sW / x);\n      sH = Math.round(sH / x);\n    }\n\n    return image;\n  };\n\n  /**\n   * Save a <canvas> element's content to a Blob object.\n   *\n   * @param {HTMLCanvasElement} canvas\n   * @return {Promise}\n   */\n\n\n  ThumbnailGenerator.prototype.canvasToBlob = function canvasToBlob(canvas, type, quality) {\n    if (canvas.toBlob) {\n      return new _Promise(function (resolve) {\n        canvas.toBlob(resolve, type, quality);\n      });\n    }\n    return _Promise.resolve().then(function () {\n      return Utils.dataURItoBlob(canvas.toDataURL(type, quality), {});\n    });\n  };\n\n  ThumbnailGenerator.prototype.getProportionalHeight = function getProportionalHeight(img, width) {\n    var aspect = img.width / img.height;\n    return Math.round(width / aspect);\n  };\n\n  /**\n   * Set the preview URL for a file.\n   */\n\n\n  ThumbnailGenerator.prototype.setPreviewURL = function setPreviewURL(fileID, preview) {\n    var _extends2;\n\n    var files = this.uppy.state.files;\n\n    this.uppy.setState({\n      files: _extends({}, files, (_extends2 = {}, _extends2[fileID] = _extends({}, files[fileID], {\n        preview: preview\n      }), _extends2))\n    });\n  };\n\n  ThumbnailGenerator.prototype.addToQueue = function addToQueue(item) {\n    this.queue.push(item);\n    if (this.queueProcessing === false) {\n      this.processQueue();\n    }\n  };\n\n  ThumbnailGenerator.prototype.processQueue = function processQueue() {\n    var _this3 = this;\n\n    this.queueProcessing = true;\n    if (this.queue.length > 0) {\n      var current = this.queue.shift();\n      return this.requestThumbnail(current).catch(function (err) {}) // eslint-disable-line handle-callback-err\n      .then(function () {\n        return _this3.processQueue();\n      });\n    } else {\n      this.queueProcessing = false;\n    }\n  };\n\n  ThumbnailGenerator.prototype.requestThumbnail = function requestThumbnail(file) {\n    var _this4 = this;\n\n    if (Utils.isPreviewSupported(file.type) && !file.isRemote) {\n      return this.createThumbnail(file, this.opts.thumbnailWidth).then(function (preview) {\n        _this4.setPreviewURL(file.id, preview);\n      }).catch(function (err) {\n        console.warn(err.stack || err.message);\n      });\n    }\n    return _Promise.resolve();\n  };\n\n  ThumbnailGenerator.prototype.install = function install() {\n    this.uppy.on('file-added', this.addToQueue);\n  };\n\n  ThumbnailGenerator.prototype.uninstall = function uninstall() {\n    this.uppy.off('file-added', this.addToQueue);\n  };\n\n  return ThumbnailGenerator;\n}(Plugin);\n//# sourceMappingURL=index.js.map",null]}